# 这是多段构建法创建的最小镜像包，完全移除了所有构建工具，仅保留模块编译结果，体积减小至300M
# 如有需要，使用该文件替换已有的Dockerfile文件
# 阶段1：构建阶段（安装依赖并编译）
FROM python:3.11-slim-bullseye as builder

RUN apt-get update && \
    apt-get install -y git build-essential python3-dev && \
    rm -rf /var/lib/apt/lists/*

# 克隆源码
RUN git clone https://github.com/A-normal/JMComic-Crawler-Python.git /app
WORKDIR /app

# 安装项目到临时目录（避免污染系统路径）
COPY requirements-dev.txt .
RUN pip install --user --no-cache-dir -r requirements-dev.txt && \
    pip install --user --no-cache-dir . 

# 阶段2：运行阶段（仅保留必要文件）
FROM python:3.11-slim-bullseye

# 设置时区
ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# 从构建阶段复制已安装的Python包
COPY --from=builder /root/.local/lib /usr/local/lib
COPY --from=builder /root/.local/bin /usr/local/bin

# 复制入口文件
COPY jm_auto.py /usr/local/bin/jm_auto.py

# 创建数据目录
RUN mkdir -p /data/Auto_Download

ENTRYPOINT ["python", "/usr/local/bin/jm_auto.py"]